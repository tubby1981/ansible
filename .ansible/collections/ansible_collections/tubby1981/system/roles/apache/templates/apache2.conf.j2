# {{ ansible_managed }}
# This is the main Apache server configuration file.  It contains the
# configuration directives that give the server its instructions.
# See http://httpd.apache.org/docs/2.4/ for detailed information.

# ServerName: Set the hostname and port that the server uses to identify itself.
{% if apache_server_name is defined and apache_server_name | length > 0 %}
ServerName {{ apache_server_name }}
{% else %}
ServerName {{ ansible_fqdn }}
{% endif %}

# ServerRoot: The top of the directory tree under which the server's
# configuration, error, and log files are kept.
ServerRoot "{{ apache_config_dir }}"

# The accept serialization lock file MUST BE STORED ON A LOCAL DISK.
#
# DefaultRuntimeDir: Directory where the server's runtime files will be stored.
# This must be an absolute path or relative to ServerRoot.
DefaultRuntimeDir {{ apache_runtime_dir | default('/var/run/apache2') }}

# Mutex: Allows you to set the mutex mechanism and mutex file directory
# for individual mutexes, or change the global defaults
Mutex file:{{ apache_lock_dir | default('/var/lock/apache2') }} default

# PidFile: The file in which the server should record its process
# identification number when it starts.
PidFile {{ apache_pid_file | default('/var/run/apache2/apache2.pid') }}

# Timeout: The number of seconds before receives and sends time out.
Timeout {{ apache_timeout | default(60) }}

# KeepAlive: Whether or not to allow persistent connections (more than
# one request per connection). Set to "Off" to deactivate.
KeepAlive {{ apache_keepalive | default('On') }}

# MaxKeepAliveRequests: The maximum number of requests to allow
# during a persistent connection. Set to 0 to allow an unlimited amount.
# We recommend you leave this number high, for maximum performance.
MaxKeepAliveRequests {{ apache_max_keepalive_requests | default(100) }}

# KeepAliveTimeout: Number of seconds to wait for the next request from the
# same client on the same connection.
KeepAliveTimeout {{ apache_keepalive_timeout | default(5) }}

# User/Group: The name (or #number) of the user/group to run httpd as.
User {{ apache_run_user | default('www-data') }}
Group {{ apache_run_group | default('www-data') }}

# HostnameLookups: Log the names of clients or just their IP addresses
# e.g., www.apache.org (on) or 204.62.129.132 (off).
# The default is off because it'd be overall better for the net if people
# had to knowingly turn this feature on.
HostnameLookups Off

# ErrorLog: The location of the error log file.
ErrorLog {{ apache_log_dir | default('/var/log/apache2') }}/error.log

# LogLevel: Control the severity of messages logged to the error_log.
# Available values: trace8, ..., trace1, debug, info, notice, warn,
# error, crit, alert, emerg.
LogLevel {{ apache_log_level | default('warn') }}

# Include module configuration:
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Include list of ports to listen on
Include ports.conf

# Sets the default security model of the Apache2 HTTPD server.
# It does not allow access to the root filesystem outside of /usr/share and /var/www.
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

<Directory /usr/share>
    AllowOverride None
    Require all granted
</Directory>

<Directory {{ apache_document_root }}>
    Options FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# AccessFileName: The name of the file to look for in each directory
# for additional configuration directives.
AccessFileName .htaccess

# The following lines prevent .htaccess and .htpasswd files from being
# viewed by Web clients.
<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

# LogFormat definitions for CustomLog directive.
# These use %O (actual bytes sent) instead of %b for better accuracy.
LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %O" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

# Include generic snippets of statements
IncludeOptional conf-enabled/*.conf

{% if apache_enable_freeipa_auth | default(false) %}
# FreeIPA LDAP Authentication
LDAPTrustedGlobalCert CA_BASE64 /etc/ipa/ca.crt
{% endif %}

# Include the virtual host configurations:
IncludeOptional sites-enabled/*.conf

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
