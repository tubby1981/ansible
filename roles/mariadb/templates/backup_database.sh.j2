#!/bin/bash
################################################################################
# MySQL/MariaDB Database Backup Script
# Generated by Ansible for {{ ansible_fqdn }}
# DO NOT modify this file manually!
################################################################################

set -euo pipefail

# Configuration
MYSQL_USER="{{ mariadb_root_username }}"
MYSQL_PASSWORD="{{ vault_mariadb_root_password }}"
BACKUP_DIR="{{ mariadb_backup_dir }}"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
HOSTNAME="{{ ansible_hostname }}"

# Commands
MYSQL="/usr/bin/mysql"
MYSQLDUMP="/usr/bin/mysqldump"
GZIP="/bin/gzip"

# Logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" >&2
}

# Check if commands exist
for cmd in mysql mysqldump gzip; do
    if ! command -v $cmd &> /dev/null; then
        error "$cmd command not found"
        exit 1
    fi
done

# Verify MySQL credentials
if ! $MYSQL -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT 1" &> /dev/null; then
    error "Failed to connect to MySQL/MariaDB"
    exit 1
fi

log "Starting database backup on {{ ansible_fqdn }}"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Get list of databases
DATABASES=$($MYSQL -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -Bse "SHOW DATABASES;" 2>/dev/null | grep -Ev '^(information_schema|performance_schema|mysql|sys)$')

if [ -z "$DATABASES" ]; then
    log "No databases found to backup"
    exit 0
fi

# Backup each database
BACKUP_COUNT=0
FAILED_COUNT=0

for db in $DATABASES; do
    BACKUP_FILE="$BACKUP_DIR/${HOSTNAME}_${db}_${TIMESTAMP}.sql.gz"
    
    log "Backing up database: $db"
    
    if $MYSQLDUMP \
        -u"$MYSQL_USER" \
        -p"$MYSQL_PASSWORD" \
        --single-transaction \
        --quick \
        --lock-tables=false \
        --routines \
        --triggers \
        --events \
        --hex-blob \
        "$db" 2>/dev/null | $GZIP > "$BACKUP_FILE"; then
        
        BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
        log "Successfully backed up $db (Size: $BACKUP_SIZE)"
        ((BACKUP_COUNT++))
    else
        error "Failed to backup database: $db"
        rm -f "$BACKUP_FILE"
        ((FAILED_COUNT++))
    fi
done

# Summary
log "Backup completed: $BACKUP_COUNT successful, $FAILED_COUNT failed"

# Set permissions
chmod 640 "$BACKUP_DIR"/*.gz 2>/dev/null || true

exit 0
