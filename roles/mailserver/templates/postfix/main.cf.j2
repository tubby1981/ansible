# Postfix main configuration file
# Generated by Ansible for {{ mailserver_hostname }}
# Mail server mode: {{ mailserver_server_mode }}

# ========================================
# Basic Configuration
# ========================================
myhostname = {{ mailserver_postfix_myhostname }}
mydomain = {{ mailserver_postfix_mydomain }}
myorigin = {{ mailserver_postfix_myorigin }}
inet_interfaces = {{ mailserver_postfix_inet_interfaces }}
inet_protocols = {{ mailserver_postfix_inet_protocols }}

# Mail delivery
mydestination = $myhostname, {{ ansible_fqdn }}, {{ ansible_hostname }}, localhost.{{ mailserver_domain }}, localhost
{% if mailserver_server_mode == 'forwarding' %}
# Forwarding only: No local mailbox storage
# All mail is forwarded via virtual_alias_maps
{% endif %}

{% if mailserver_postfix_use_relay %}
relayhost = [{{ mailserver_postfix_relay_host }}]:{{ mailserver_postfix_relay_port }}

smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_sasl_security_options = noanonymous
smtp_sasl_tls_security_options = noanonymous

smtp_tls_security_level = may
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
{% else %}
relayhost =
{% endif %}
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
message_size_limit = {{ mailserver_postfix_message_size_limit }}

# ========================================
# Aliases
# ========================================
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases

# ========================================
# Virtual Domains Configuration
# ========================================
virtual_mailbox_domains = mysql:/etc/postfix/mysql/mysql-virtual-mailbox-domains.cf
virtual_alias_maps = mysql:/etc/postfix/mysql/mysql-virtual-alias-maps.cf

{% if mailserver_server_mode in ['forwarding', 'both'] %}
# Forwarding: Support alias domains
#virtual_alias_domains = mysql:/etc/postfix/mysql/mysql-virtual-alias-domain-maps.cf
{% endif %}

{% if mailserver_server_mode in ['mailboxes', 'both'] %}
# Mailboxes: Virtual mailbox configuration
virtual_mailbox_maps = mysql:/etc/postfix/mysql/mysql-virtual-mailbox-maps.cf
virtual_mailbox_base = {{ mailserver_storage_path }}
virtual_minimum_uid = {{ mailserver_uid }}
virtual_uid_maps = static:{{ mailserver_uid }}
virtual_gid_maps = static:{{ mailserver_gid }}
virtual_transport = lmtp:unix:private/dovecot-lmtp
{% endif %}

{% if mailserver_server_mode == 'forwarding' %}
# Forwarding only: No local mailbox storage
# All mail is forwarded via virtual_alias_maps
{% endif %}

# ========================================
# TLS Configuration for Incoming Connections
# ========================================
smtpd_tls_cert_file = {{ mailserver_ssl_certificate }}
smtpd_tls_key_file = {{ mailserver_ssl_certificate_key }}
smtpd_tls_security_level = may
smtpd_tls_auth_only = yes
smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_ciphers = high
smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_mandatory_ciphers = high
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes

# ========================================
# TLS Configuration for Outgoing Connections
# ========================================
smtp_tls_cert_file = {{ mailserver_ssl_certificate }}
smtp_tls_key_file = {{ mailserver_ssl_certificate_key }}
smtp_tls_security_level = may
smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_ciphers = high
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
smtp_tls_loglevel = 1

{% if mailserver_server_mode in ['mailboxes', 'both'] %}
# ========================================
# SASL Authentication (for mailbox access)
# ========================================
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname
broken_sasl_auth_clients = yes
{% endif %}

# ========================================
# SMTP Restrictions
# ========================================
smtpd_helo_required = yes
smtpd_helo_restrictions = permit_mynetworks,{% if mailserver_server_mode in ['mailboxes', 'both'] %}permit_sasl_authenticated,{% endif %}reject_invalid_helo_hostname,reject_non_fqdn_helo_hostname,reject_unknown_helo_hostname
smtpd_sender_restrictions = permit_mynetworks,{% if mailserver_server_mode in ['mailboxes', 'both'] %}permit_sasl_authenticated,{% endif %}reject_non_fqdn_sender,reject_unknown_sender_domain
smtpd_recipient_restrictions = permit_mynetworks,{% if mailserver_server_mode in ['mailboxes', 'both'] %}permit_sasl_authenticated,{% endif %}reject_non_fqdn_recipient,reject_unknown_recipient_domain,reject_unauth_destination,{% for rbl in mailserver_postfix_rbl_clients %}reject_rbl_client {{ rbl }},{% endfor %}check_policy_service unix:private/policyd-spf,permit
smtpd_data_restrictions = reject_unauth_pipelining,permit

# ========================================
# SPF Policy
# ========================================
policyd-spf_time_limit = 3600

# ========================================
# DKIM Milter Configuration (ClamAV + OpenDKIM)
# ========================================
milter_default_action = accept
milter_protocol = 6
smtpd_milters = inet:127.0.0.1:8891
non_smtpd_milters = $smtpd_milters

# ========================================
# Performance Tuning
# ========================================
default_process_limit = 100
smtpd_client_connection_count_limit = 10
smtpd_client_connection_rate_limit = 30
anvil_rate_time_unit = 60s

# ========================================
# Logging
# ========================================
maillog_file = /var/log/mail.log

# ========================================
# Compatibility Level
# ========================================
compatibility_level = {{ mailserver_postfix_compatibility_level }}
smtpd_banner = $myhostname ESMTP
