# {{ ansible_managed }}
# VirtualHost configuration for {{ item.server_name }}

{# ============================================================
   ALWAYS CREATE HTTP VHOST
   This is required for:
   - HTTP-01 Let’s Encrypt challenge
   - Non-LE normal HTTP hosting
   - Certbot --apache automation
   ============================================================ #}

<VirtualHost {{ apache_listen_addresses | join(' ') }}:{{ item.port | default(80) }}>
    ServerName {{ item.server_name }}
{% if item.aliases is defined %}
{% for alias in item.aliases %}
    ServerAlias {{ alias }}
{% endfor %}
{% endif %}

    DocumentRoot {{ item.document_root | default(apache_document_root) }}

    <Directory {{ item.document_root | default(apache_document_root) }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

{# ============================  
   URL / DIRECTORY PROTECTION  
   ============================ #}

{% set protections = item.url_protection | default(apache_security_restrictions | default([])) %}

{% for rule in protections %}
    <Location "{{ rule.path }}">
{% if rule.allowed_ips | length == 1 and rule.allowed_ips[0] == "all" %}
        Require all granted
{% else %}
        Require all denied
{% for ip in rule.allowed_ips %}
        Require ip {{ ip }}
{% endfor %}
{% endif %}
    </Location>
{% endfor %}

    ErrorLog ${APACHE_LOG_DIR}/{{ item.server_name }}_error.log
    CustomLog ${APACHE_LOG_DIR}/{{ item.server_name }}_access.log combined

{% if item.with_letsencrypt %}
    # Let’s Encrypt will inject redirects when certificate is issued
    # DO NOT add manual redirects here.
{% else %}
    {% if item.redirect_https | default(false) and item.ssl | default(false) %}
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/(.*)$ https://%{SERVER_NAME}/$1 [R=301,L]
    {% endif %}
{% endif %}

{% if item.rewrite_rules is defined and (item.rewrite_rules | length > 0) and not item.with_letsencrypt %}
    # Custom rewrite rules (only when not using Let's Encrypt)
{% for rule in item.rewrite_rules %}
    {{ rule }}
{% endfor %}
{% endif %}
</VirtualHost>

{# ============================================================
   OPTIONAL HTTPS VHOST (ONLY when NOT using Let's Encrypt)
   Because HTTPS will be created by Certbot automatically
   for HTTP-01 challenges.
   ============================================================ #}

{% if item.ssl | default(false) and not item.with_letsencrypt %}
<VirtualHost {{ apache_listen_addresses | join(' ') }}:{{ item.ssl_port | default(443) }}>
    ServerName {{ item.server_name }}
{% if item.aliases is defined %}
{% for alias in item.aliases %}
    ServerAlias {{ alias }}
{% endfor %}
{% endif %}

    DocumentRoot {{ item.document_root | default(apache_document_root) }}

    <Directory {{ item.document_root | default(apache_document_root) }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

{# ============================  
   URL / DIRECTORY PROTECTION  
   ============================ #}

{% set protections = item.url_protection | default(apache_security_restrictions | default([])) %}

{% for rule in protections %}
    <Location "{{ rule.path }}">
{% if rule.allowed_ips | length == 1 and rule.allowed_ips[0] == "all" %}
        Require all granted
{% else %}
        Require all denied
{% for ip in rule.allowed_ips %}
        Require ip {{ ip }}
{% endfor %}
{% endif %}
    </Location>
{% endfor %}

    SSLEngine on

    # Manual certificates must be provided here
    SSLCertificateFile /etc/ssl/certs/{{ item.server_name }}.crt
    SSLCertificateKeyFile /etc/ssl/private/{{ item.server_name }}.key

    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite {{ apache_cipher_suite }}
    SSLHonorCipherOrder off
    SSLSessionTickets off

    Header always set Strict-Transport-Security "max-age=31536000"

    ErrorLog ${APACHE_LOG_DIR}/{{ item.server_name }}_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}}/{{ item.server_name }}_ssl_access.log combined

{% if item.rewrite_rules is defined and (item.rewrite_rules | length > 0) %}
    # HTTPS custom rewrite rules
{% for rule in item.rewrite_rules %}
    {{ rule }}
{% endfor %}
{% endif %}
</VirtualHost>
{% endif %}


{# ============================================================
   LET'S ENCRYPT MODE
   For HTTP-01:
     - Certbot will update this HTTP vhost
     - Certbot will create an HTTPS vhost automatically
   For DNS-01:
     - HTTP vhost stays as-is
     - SSL vhost is created via vhost-ssl.conf.j2
   ============================================================ #}

{% if item.with_letsencrypt %}
# ============================================================================
# Let’s Encrypt enabled for {{ item.server_name }}
# Certbot will modify or extend VirtualHost configuration as required.
# DO NOT manually add SSL VirtualHosts when using HTTP-01 challenges.
# ============================================================================
{% endif %}

