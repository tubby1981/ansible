---
# -------------------------------------------------
# Apache Role – Main Tasks
# -------------------------------------------------

- name: "Include OS-specific variables (optional)"
  include_vars: "{{ ansible_os_family }}.yml"
  ignore_errors: true
  tags: [apache, configuration]

# --------------------------------------------------------------------
# 1. Install Apache package
# --------------------------------------------------------------------
- name: Install Apache webserver
  package:
    name: "{{ apache_package_name }}"
    state: present
  when: apache_enabled
  tags: [apache, installation]

# --------------------------------------------------------------------
# 2. Ensure Apache environment variables are set (Debian/Ubuntu)
# --------------------------------------------------------------------
- name: Deploy Apache envvars file (Debian/Ubuntu)
  copy:
    src: envvars
    dest: "{{ apache_config_dir }}/envvars"
    owner: root
    group: root
    mode: '0644'
  when:
    - apache_enabled
    - ansible_os_family == "Debian"
  tags: [apache, configuration]

- name: Ensure Apache runtime directory exists
  file:
    path: "/var/run/apache2"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when:
    - apache_enabled
    - ansible_os_family == "Debian"
  tags: [apache, configuration]

- name: Ensure Apache lock directory exists
  file:
    path: "/var/lock/apache2"
    state: directory
    owner: "{{ apache_run_user | default('www-data') }}"
    group: "{{ apache_run_group | default('www-data') }}"
    mode: '0755'
  when:
    - apache_enabled
    - ansible_os_family == "Debian"
  tags: [apache, configuration]

# --------------------------------------------------------------------
# 3. Deploy main Apache configuration and ports.conf
# --------------------------------------------------------------------
- name: Deploy main Apache configuration (apache2.conf)
  template:
    src: apache2.conf.j2
    dest: "{{ apache_config_dir }}/apache2.conf"
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify: Restart apache
  when: apache_enabled
  tags: [apache, configuration]

- name: Deploy Apache ports configuration
  template:
    src: ports.conf.j2
    dest: "{{ apache_config_dir }}/ports.conf"
    owner: root
    group: root
    mode: '0644'
  notify: Restart apache
  when: apache_enabled
  tags: [apache, configuration, ports]

- name: Deploy Apache security configuration
  template:
    src: security.conf.j2
    dest: "{{ apache_config_dir }}/conf-available/security.conf"
    owner: root
    group: root
    mode: '0644'
  notify: Restart apache
  when:
    - apache_enabled
    - ansible_os_family == "Debian"
  tags: [apache, configuration, security]

- name: Enable security configuration
  file:
    src: "{{ apache_config_dir }}/conf-available/security.conf"
    dest: "{{ apache_config_dir }}/conf-enabled/security.conf"
    state: link
  when:
    - apache_enabled
    - ansible_os_family == "Debian"
  notify: Restart apache
  tags: [apache, configuration, security]

# --------------------------------------------------------------------
# 4. Enable required Apache modules
# --------------------------------------------------------------------
- name: Enable common Apache modules
  apache2_module:
    name: "{{ item }}"
    state: present
  loop: "{{ apache_modules_enabled }}"
  when:
    - apache_enabled
    - ansible_os_family == "Debian"
  notify: Restart apache
  tags: [apache, modules]

- name: Enable ssl module when SSL ports or ssl vhosts are defined
  apache2_module:
    name: "ssl"
    state: present
  when:
    - apache_enabled
    - (apache_ssl_ports | length) > 0 or (apache_vhosts | selectattr('ssl','defined') | list | length) > 0
    - ansible_os_family == "Debian"
  notify: Restart apache
  tags: [apache, modules, ssl]

# --------------------------------------------------------------------
# 5. Ensure document root directories exist (per vhost)
# --------------------------------------------------------------------
- name: Create document root directories for VHosts
  file:
    path: "{{ item.document_root | default(apache_document_root) }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
    recurse: true
  loop: "{{ apache_vhosts }}"
  when: apache_enabled and (item.enabled | default(true))
  tags: [apache, vhosts]

# --------------------------------------------------------------------
# 6. Deploy VHost configuration files
# --------------------------------------------------------------------
- name: Deploy Apache VHost configuration files
  template:
    src: vhost.conf.j2
    dest: "{{ apache_sites_available_dir }}/{{ item.server_name }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ apache_vhosts }}"
  when: apache_enabled and (item.enabled | default(true))
  notify: Restart apache
  tags: [apache, vhosts, configuration]

- name: Enable Apache VHosts (symlink sites-enabled)
  file:
    src: "{{ apache_sites_available_dir }}/{{ item.server_name }}.conf"
    dest: "{{ apache_sites_enabled_dir }}/{{ item.server_name }}.conf"
    state: link
  loop: "{{ apache_vhosts }}"
  when: apache_enabled and (item.enabled | default(true))
  notify: Restart apache
  tags: [apache, vhosts]

# --------------------------------------------------------------------
# 7. Validate Apache configuration before continuing
# --------------------------------------------------------------------
- name: Test Apache configuration syntax
  command: apache2ctl configtest
  register: apache_configtest
  changed_when: false
  failed_when: false
  when:
    - apache_enabled
    - ansible_os_family == "Debian"
  tags: [apache, validation]

- name: Display Apache configuration test results
  debug:
    msg: "{{ apache_configtest.stderr_lines }}"
  when:
    - apache_enabled
    - apache_configtest is defined
    - apache_configtest.rc != 0
  tags: [apache, validation]

- name: Fail if Apache configuration is invalid
  fail:
    msg: |
      Apache configuration test failed!
      Please review the configuration errors above.
  when:
    - apache_enabled
    - apache_configtest is defined
    - apache_configtest.rc != 0
    - "'Syntax OK' not in apache_configtest.stderr"
  tags: [apache, validation]

# --------------------------------------------------------------------
# 8. Start Apache before Certbot (required for HTTP-01 challenge)
# --------------------------------------------------------------------
- name: Ensure Apache is started before requesting certificates
  service:
    name: "{{ apache_service_name }}"
    state: started
    enabled: true
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "http"
  tags: [apache, certbot]

# --------------------------------------------------------------------
# 9. Certbot / Let's Encrypt (with pre-flight checks)
# --------------------------------------------------------------------
- name: Install Certbot and required plugins
  package:
    name: "{{ apache_certbot_packages }}"
    state: present
  when: apache_certbot_enabled
  tags: [certbot, letsencrypt]

- name: Verify Certbot email is configured
  fail:
    msg: "apache_certbot_email must be set when apache_certbot_enabled is true"
  when:
    - apache_certbot_enabled
    - (apache_certbot_email | length) == 0
  tags: [certbot, letsencrypt]

# --------------------------------------------------------------------
# HTTP-01 Challenge: DNS verification
# --------------------------------------------------------------------
- name: "Pre-flight (HTTP-01): Check DNS resolution for Let's Encrypt domains (aliases)"
  command: "host {{ item.1 }}"
  loop: "{{ apache_vhosts | subelements('aliases', skip_missing=True) }}"
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "http"
    - (item.0.enabled | default(true))
    - (item.0.with_letsencrypt | default(false))
  register: dns_check
  failed_when: false
  changed_when: false
  tags: [certbot, letsencrypt, preflight, http-01]

- name: "Pre-flight (HTTP-01): Check DNS resolution for primary domain"
  command: "host {{ item.server_name }}"
  loop: "{{ apache_vhosts }}"
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "http"
    - (item.enabled | default(true))
    - (item.with_letsencrypt | default(false))
  register: dns_check_primary
  failed_when: false
  changed_when: false
  tags: [certbot, letsencrypt, preflight, http-01]

- name: "Pre-flight (HTTP-01): Report DNS check results"
  debug:
    msg: |
      ⚠️  DNS CHECK WARNING ⚠️

      The following domains are not correctly configured in DNS:
      {% for result in dns_check.results | default([]) %}
      {% if result.rc is defined and result.rc != 0 %}
        - {{ result.item.1 }} (alias of {{ result.item.0.server_name }})
      {% endif %}
      {% endfor %}
      {% for result in dns_check_primary.results | default([]) %}
      {% if result.rc is defined and result.rc != 0 %}
        - {{ result.item.server_name }} (primary domain)
      {% endif %}
      {% endfor %}

      Let's Encrypt requires that ALL domains point to this server.
      Configure the DNS A-records and try again.
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "http"
    - (
        dns_check.results | default([])
        | selectattr('rc','defined')
        | selectattr('rc','ne',0)
        | list | length > 0
      )
      or
      (
        dns_check_primary.results | default([])
        | selectattr('rc','defined')
        | selectattr('rc','ne',0)
        | list | length > 0
      )  
  tags: [certbot, letsencrypt, preflight, http-01]

- name: "Pre-flight (HTTP-01): Fail if DNS is not configured"
  fail:
    msg: |
      ❌ Let's Encrypt cannot proceed: DNS records are missing!
      
      Verify that all domains correctly point to {{ ansible_default_ipv4.address | default('this server') }}.
      Use 'dig' or 'nslookup' to verify DNS configuration.
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "http"
    - apache_certbot_strict_dns_check | default(true)
    - (dns_check.results | default([]) | selectattr('rc', 'ne', 0) | list | length > 0) or
      (dns_check_primary.results | default([]) | selectattr('rc', 'ne', 0) | list | length > 0)
  tags: [certbot, letsencrypt, preflight, http-01]

# --------------------------------------------------------------------
# DNS-01 Challenge: Verify DNS provider credentials
# --------------------------------------------------------------------
- name: "Pre-flight (DNS-01): Verify DNS provider plugin is configured"
  fail:
    msg: |
      ❌ DNS-01 challenge requires apache_certbot_dns_provider to be set!
      
      Supported providers: cloudflare, route53, digitalocean, google, etc.
      Example: apache_certbot_dns_provider: "cloudflare"
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "dns"
    - (apache_certbot_dns_provider | length) == 0
  tags: [certbot, letsencrypt, preflight, dns-01]

- name: "Pre-flight (DNS-01): Verify DNS credentials file exists"
  fail:
    msg: |
      ❌ DNS-01 challenge requires apache_certbot_dns_credentials_file to be set!
      
      Example: apache_certbot_dns_credentials_file: "/root/.secrets/certbot/cloudflare.ini"
      
      See README.md for credential file format per DNS provider.
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "dns"
    - (apache_certbot_dns_credentials_file | length) == 0
  tags: [certbot, letsencrypt, preflight, dns-01]

- name: "Pre-flight (DNS-01): Create credentials directory"
  file:
    path: "{{ apache_certbot_dns_credentials_file | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0700'
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "dns"
    - apache_certbot_dns_credentials_file | length > 0
  tags: [certbot, letsencrypt, dns-01]

- name: "Pre-flight (DNS-01): Deploy DNS credentials file"
  copy:
    dest: "{{ apache_certbot_dns_credentials_file }}"
    content: "{{ apache_certbot_dns_credentials_content }}"
    owner: root
    group: root
    mode: '0600'
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "dns"
    - apache_certbot_dns_credentials_content | length > 0
  no_log: true  # Don't log credentials
  tags: [certbot, letsencrypt, dns-01]

# --------------------------------------------------------------------
# Obtain Let's Encrypt certificates
# --------------------------------------------------------------------
- name: "Obtain Let's Encrypt certificates (HTTP-01 challenge)"
  command: >-
    certbot --apache
      --non-interactive
      --agree-tos
      --email {{ apache_certbot_email }}
      --domains {{ ([item.server_name] + (item.aliases | default([]))) | join(',') }}
      --redirect
  loop: "{{ apache_vhosts }}"
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "http"
    - (item.enabled | default(true))
    - (item.with_letsencrypt | default(false))
  register: certbot_result_http
  changed_when: "'Congratulations' in certbot_result_http.stdout or 'Successfully received certificate' in certbot_result_http.stdout"
  failed_when: certbot_result_http.rc != 0 and 'Certificate not yet due for renewal' not in certbot_result_http.stdout
  tags: [certbot, letsencrypt, certificates, http-01]

- name: "Obtain Let's Encrypt certificates (DNS-01 challenge)"
  command: >-
    certbot certonly
      --non-interactive
      --agree-tos
      --email {{ apache_certbot_email }}
      --dns-{{ apache_certbot_dns_provider }}
      --dns-{{ apache_certbot_dns_provider }}-credentials {{ apache_certbot_dns_credentials_file }}
      --domains {{ ([item.server_name] + (item.aliases | default([]))) | join(',') }}
      --dns-{{ apache_certbot_dns_provider }}-propagation-seconds {{ apache_certbot_dns_propagation_seconds }}
  loop: "{{ apache_vhosts }}"
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "dns"
    - (item.enabled | default(true))
    - (item.with_letsencrypt | default(false))
  register: certbot_result_dns
  changed_when: "'Congratulations' in certbot_result_dns.stdout or 'Successfully received certificate' in certbot_result_dns.stdout"
  failed_when: certbot_result_dns.rc != 0 and 'Certificate not yet due for renewal' not in certbot_result_dns.stdout
  tags: [certbot, letsencrypt, certificates, dns-01]

- name: "Configure Apache to use Let's Encrypt certificates (DNS-01 only)"
  template:
    src: vhost-ssl.conf.j2
    dest: "{{ apache_sites_available_dir }}/{{ item.item.server_name }}-le-ssl.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ certbot_result_dns.results | default([]) }}"
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "dns"
    - not item.skipped | default(false)
  notify: Restart apache
  tags: [certbot, letsencrypt, dns-01]

- name: "Enable SSL VHost configuration (DNS-01 only)"
  file:
    src: "{{ apache_sites_available_dir }}/{{ item.item.server_name }}-le-ssl.conf"
    dest: "{{ apache_sites_enabled_dir }}/{{ item.item.server_name }}-le-ssl.conf"
    state: link
  loop: "{{ certbot_result_dns.results | default([]) }}"
  when:
    - apache_certbot_enabled
    - apache_certbot_challenge_method == "dns"
    - not item.skipped | default(false)
  notify: Restart apache
  tags: [certbot, letsencrypt, dns-01]

- name: Display Certbot results
  debug:
    msg: |
      ✅ Certificate successfully obtained for: {{ item.item.server_name }}
      Domains: {{ ([item.item.server_name] + (item.item.aliases | default([]))) | join(', ') }}
      Challenge method: {{ apache_certbot_challenge_method | upper }}
  loop: "{{ (certbot_result_http.results | default([])) + (certbot_result_dns.results | default([])) }}"
  when:
    - item.changed | default(false)
    - not item.skipped | default(false)
  tags: [certbot, letsencrypt]

# --------------------------------------------------------------------
# Setup automatic certificate renewal
# --------------------------------------------------------------------
- name: Setup automatic certificate renewal (systemd timer)
  systemd:
    name: certbot.timer
    enabled: true
    state: started
  when:
    - apache_certbot_enabled
    - apache_certbot_auto_renew
    - ansible_service_mgr == "systemd"
  tags: [certbot, renewal]

- name: Setup automatic certificate renewal (cron)
  cron:
    name: "Certbot certificate renewal"
    minute: "0"
    hour: "2"
    job: "{{ apache_certbot_renew_command }}"
    user: root
  when:
    - apache_certbot_enabled
    - apache_certbot_auto_renew
    - ansible_service_mgr != "systemd"
  tags: [certbot, renewal]
