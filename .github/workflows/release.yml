---
name: Release to Galaxy

on:
  release:
    types: [published]

jobs:
  deploy:
    name: Publish to Ansible Galaxy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: pip install ansible-core
      
      - name: Build collection
        run: ansible-galaxy collection build
      
      - name: Publish to Galaxy
        run: |
          ansible-galaxy collection publish *.tar.gz \
            --token ${{ secrets.GALAXY_API_KEY }}
        env:
          ANSIBLE_GALAXY_SERVER_LIST: release_galaxy
      
      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.tar.gz'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
